# azure-synapse

Creates a Synapse Workspace with primary storage data lake gen2 filesystem. Supports the creation of zero to many SQL Pools and firewall rules. A SQL admin login and password are generated by the module as per Synapse requirement.
By design the password is not outputted by the module and we encourage the use of the Azure Active Directory Admin (user or group) for administration of Synapse.

## Public Access and firewall rules

The Synapse module sets the 'public\_network\_access\_enabled' value to false by default, in expectation that any real world deployments should use private endpoints to manage connectivity. This setting can be overwritten if required
but this is not advised. In deployments where public access needs to be enabled, firewall rules should be set accordingly. In this scenario a series of firewall rules are created by default to allow access to the shared cicd build
agents and Azure services. A boolean variable `fwrule_include_sharedBuildAgents` can be set to false in scenarios where access to the cicd subnets in not desired. (NB: firewall rules are disabled when public access is set to false
and as such the module skips the resource)

## SQl Pools

Synapse Workspaces come with a 'built-in' scalable serverless (pay-as-you-go) SQL Pool by default. However, the module also allows for additional dedicated SQL pools to be created as required.  

## SQL Admin, Azure Active Directory Administrator & Synapse RBAC roles

The module creates a SQL administrator by default (a requirement of a Synapse Workspace) and a password will be auto generated for this if not provided by the calling code. Our recommendation is that an Azure AD Administrator (user or group)
is created for all Synapse Workspaces and we advise that the SQL admin login should not be used. For this reason we have deliberately not outputted the auto generated SQL admin password.
Synapse RBAC roles can be passed into the module and by default any AAD Admin created for the workspace will also be created as a 'Synapse Administrator' in Synapse Studio. This is to prevent a scenario where a Synapse Workspace
is created but only the MI that creates it has admin permissions at a Synapse Studio level.

## Additional info

* A wait resource has been added after the creation of the Synapse Workspace and firewall rules (if created) to prevent an issue where RBAC rule creation fails to access the Synapse API.
* There is a known bug where the creation of a SQL Pool with TDE fails in Terraform. In reality the SQL pool is created successfully and TDE is enabled. Subsequent Terraform applies will complete successfully.

## How To Use

### Baseline deployment

```terraform
module "azure-synapse" {
  source              = "git@ssh.dev.azure.com:v3/hiscox/gp-psg/terraform-modules//azure-synapse"
  environment         = var.environment
  application         = var.application
  location            = var.location
  storage_account_id  = "xxx-xxx-xxx"
}
```

### SQL pools deployment

```terraform
module "azure-synapse" {
  source              = "git@ssh.dev.azure.com:v3/hiscox/gp-psg/terraform-modules//azure-synapse"
  environment         = var.environment
  application         = var.application
  location            = var.location
  storage_account_id  = "xxx-xxx-xxx"
  sqlpools            = var.sqlpools
}
```

### SQL pools with public access enabled deployment

```terraform
module "azure-synapse" {
source                        = "git@ssh.dev.azure.com:v3/hiscox/gp-psg/terraform-modules//azure-synapse"
environment                   = var.environment
application                   = var.application
location                      = var.location
storage_account_id            = "xxx-xxx-xxx"
public_network_access_enabled = "true"
sqlpools                      = var.sqlpools
fwrules                       = var.fwrules
}
```

## How To Update this README.md

* terraform-docs has been used to automatically generate this readme based on comments, variables.tf and output.tf.
* Follow the setup instructions here: https://github.com/segmentio/terraform-docs
* Write your terraform-docs to a file like so: `terraform-docs md . | Out-File README.md`

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | >= 2, < 3 |
| <a name="requirement_time"></a> [time](#requirement\_time) | >=0.7, < 1 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azuread"></a> [azuread](#provider\_azuread) | n/a |
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | >= 2, < 3 |
| <a name="provider_random"></a> [random](#provider\_random) | n/a |
| <a name="provider_time"></a> [time](#provider\_time) | >=0.7, < 1 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azurerm_resource_group.rg](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_storage_data_lake_gen2_filesystem.storage_dlg2fs_synapse](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_data_lake_gen2_filesystem) | resource |
| [azurerm_synapse_firewall_rule.fwrule](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/synapse_firewall_rule) | resource |
| [azurerm_synapse_role_assignment.synrbacroles](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/synapse_role_assignment) | resource |
| [azurerm_synapse_sql_pool.sqlpools](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/synapse_sql_pool) | resource |
| [azurerm_synapse_workspace.syw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/synapse_workspace) | resource |
| [random_password.sql_admin_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/password) | resource |
| [random_string.dlg2fs_name](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string) | resource |
| [time_sleep.wait_120_seconds](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) | resource |
| [time_static.t](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/static) | resource |
| [azuread_group.aad_admin_group](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/group) | data source |
| [azuread_user.aad_admin_user](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/user) | data source |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) | data source |
| [azurerm_resource_group.rg](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/resource_group) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_aad_admin_group"></a> [aad\_admin\_group](#input\_aad\_admin\_group) | The Azure AD Admin group for the Synapse Workspace | `string` | `""` | no |
| <a name="input_aad_admin_user"></a> [aad\_admin\_user](#input\_aad\_admin\_user) | The Azure AD Admin user for the Synapse Workspace | `string` | `""` | no |
| <a name="input_application"></a> [application](#input\_application) | Name of the application | `string` | n/a | yes |
| <a name="input_environment"></a> [environment](#input\_environment) | The environment name. Used as a tag and in naming the resource group | `string` | n/a | yes |
| <a name="input_fwrule_include_sharedBuildAgents"></a> [fwrule\_include\_sharedBuildAgents](#input\_fwrule\_include\_sharedBuildAgents) | A boolean switch to allow for scenarios where the default set of shared cicd subnets (containing Bamboo/ADO agents) should not be added to the Synapse Workspace firewall rules | `bool` | `true` | no |
| <a name="input_fwrules"></a> [fwrules](#input\_fwrules) | "List of maps detailing Synapse firewall rules with the following structure):<br>[<br>  {<br>    name             = "examplepool"<br>    start\_ip\_address = "0.0.0.0"<br>    end\_ip\_address   = "0.0.0.0"<br>  }<br>]" | `list(map(string))` | `[]` | no |
| <a name="input_location"></a> [location](#input\_location) | The region resources will be deployed to | `string` | `"northeurope"` | no |
| <a name="input_public_network_access_enabled"></a> [public\_network\_access\_enabled](#input\_public\_network\_access\_enabled) | Toggles public network access for Synapse Workspace (defaults to disabled, but needs to be enabled if there is no public endpoint and firewall rules need to be set) | `string` | `"false"` | no |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | The target resource group this module should be deployed into. If not specified one will be created for you with name like: environment-application-template-location | `string` | `""` | no |
| <a name="input_sql_administrator_password"></a> [sql\_administrator\_password](#input\_sql\_administrator\_password) | The password of the login for the SQL server administrator | `string` | `""` | no |
| <a name="input_sqlpools"></a> [sqlpools](#input\_sqlpools) | "List of maps detailing Synapse SQL Pools with the following structure (collation defaults to SQL\_LATIN1\_GENERAL\_CP1\_CI\_AS if not set):<br>[<br>  {<br>    name          = "examplepool"<br>    pool\_sku\_name = "DW100c"<br>    collation     = "SQL\_LATIN1\_GENERAL\_CP1\_CI\_AS"<br>  }<br>]" | `list(map(string))` | `[]` | no |
| <a name="input_storage_account_id"></a> [storage\_account\_id](#input\_storage\_account\_id) | Name of the storage account for storing logs | `string` | n/a | yes |
| <a name="input_synapse_dlg2fs_name"></a> [synapse\_dlg2fs\_name](#input\_synapse\_dlg2fs\_name) | Name of the Synapse Workspace primary data lake gen2 filesystem | `string` | `""` | no |
| <a name="input_synapse_name"></a> [synapse\_name](#input\_synapse\_name) | Name of the Synapse workspace | `string` | `""` | no |
| <a name="input_synrbacroles"></a> [synrbacroles](#input\_synrbacroles) | "List of maps detailing Syanpse RBAC Roles:<br>[<br>  {<br>    role\_name    = "Synapse Contributor"<br>    principal\_id = xxx-xxx-xxx<br>  }<br>]" | `list(map(string))` | `[]` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | List of tags to be applied to resources | `map(string)` | `{}` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_aad_admin"></a> [aad\_admin](#output\_aad\_admin) | Name of Azure Active Directory Admin |
| <a name="output_connectivity_endpoints"></a> [connectivity\_endpoints](#output\_connectivity\_endpoints) | A list of Connectivity endpoints for this Synapse Workspace |
| <a name="output_resource_group_name"></a> [resource\_group\_name](#output\_resource\_group\_name) | Name of the resource group where resources have been deployed to |
| <a name="output_sql_admin_login"></a> [sql\_admin\_login](#output\_sql\_admin\_login) | Name of the SQL administrator login |
| <a name="output_sqlpools"></a> [sqlpools](#output\_sqlpools) | Map of sqlpools |
| <a name="output_synapse_dlg2fs_id"></a> [synapse\_dlg2fs\_id](#output\_synapse\_dlg2fs\_id) | ID of the Synapse dlg2fs |
| <a name="output_synapse_id"></a> [synapse\_id](#output\_synapse\_id) | ID of the Synapse workspace |
